local agent_script={};agent_script.ui={};local STATES={FOLLOWING="FOLLOWING",FIGHTING="FIGHTING",FARMING="FARMING",MANUAL_OVERRIDE="MANUAL",INTERRUPTING="INTERRUPTING"};local my_hero,local_player,font,agent_manager=nil,nil,nil,{};local FOUNTAIN_LOCATIONS={[Enum.TeamNum.TEAM_RADIANT]=Vector(-7019,-6534,384),[Enum.TeamNum.TEAM_DIRE]=Vector(6846,6251,384)};local DeliveryManager={isActive=false,target=nil,itemsQueue={},currentDelivery=nil,lastOrderTime=0,currentDeliveryStartTime=0};function DeliveryManager:StartDelivery(deliveryTarget)if self.isActive then return end;local courier=Couriers.GetLocal();if not courier or not Entity.IsAlive(courier)then return end;self.isActive=true;self.target=deliveryTarget;self.itemsQueue={};self.currentDelivery=nil;for i=0,20 do local item=NPC.GetItemByIndex(courier,i,false);if item then local itemName=Ability.GetName(item);if itemName~="courier_shield"and itemName~="courier_burst"and itemName~="courier_go_to_secret_shop"then table.insert(self.itemsQueue,{item=item,slot=i})end end end;if #self.itemsQueue==0 then self:StopDelivery();return end;self:ProcessNextItem()end;function DeliveryManager:StopDelivery(reason)if not self.isActive then return end;self.isActive=false;self.target=nil;self.itemsQueue={};self.currentDelivery=nil;self.currentDeliveryStartTime=0;local courier=Couriers.GetLocal();if courier and Entity.IsAlive(courier)and my_hero then local local_team=Entity.GetTeamNum(my_hero);local fountain_pos=FOUNTAIN_LOCATIONS[local_team];if fountain_pos then Player.PrepareUnitOrders(Players.GetLocal(),Enum.UnitOrder.DOTA_UNIT_ORDER_MOVE_TO_POSITION,nil,fountain_pos,nil,Enum.PlayerOrderIssuer.DOTA_ORDER_ISSUER_PASSED_UNIT_ONLY,courier)end end end;function DeliveryManager:ProcessNextItem()if #self.itemsQueue==0 then self:StopDelivery();return end;self.currentDelivery=table.remove(self.itemsQueue,1);self.currentDeliveryStartTime=GlobalVars.GetCurTime()end;function DeliveryManager:OnUpdate()if not self.isActive then return end;local courier=Couriers.GetLocal();if not self.target or not Entity.IsAlive(self.target)then return self:StopDelivery()end;if not courier or not Entity.IsAlive(courier)then return self:StopDelivery()end;if not self.currentDelivery then return end;local DELIVERY_TIMEOUT=10.0;if GlobalVars.GetCurTime()>self.currentDeliveryStartTime+DELIVERY_TIMEOUT then self:ProcessNextItem();return end;local itemInSlot=NPC.GetItemByIndex(courier,self.currentDelivery.slot,false);if itemInSlot and itemInSlot==self.currentDelivery.item then local currentTime=GlobalVars.GetCurTime();if currentTime>self.lastOrderTime+0.5 then Player.PrepareUnitOrders(Players.GetLocal(),Enum.UnitOrder.DOTA_UNIT_ORDER_GIVE_ITEM,self.target,nil,self.currentDelivery.item,Enum.PlayerOrderIssuer.DOTA_ORDER_ISSUER_PASSED_UNIT_ONLY,courier);self.lastOrderTime=currentTime end else self:ProcessNextItem()end end;function DeliveryManager:OnGameEnd()if self.isActive then self:StopDelivery()end end;local CourierPanelModule={ui={},is_visible=false,show_until_time=0,panel_size=Vec2(200,80),font=nil,current_alpha=0,animation_speed=7.0};function CourierPanelModule:Init(courier_group)self.font=Render.LoadFont("Arial",16,Enum.FontCreate.FONTFLAG_OUTLINE);local show_panel_callback=function()self:Show(3)end;self.ui.pos_x=courier_group:Slider("Позиция панели по X",0,Render.ScreenSize().x,867,"%.0f");self.ui.pos_y=courier_group:Slider("Позиция панели по Y",0,Render.ScreenSize().y,82,"%.0f");self.ui.pos_x:ToolTip("Горизонтальное положение панели выбора на экране.");self.ui.pos_y:ToolTip("Вертикальное положение панели выбора на экране.");self.ui.pos_x:SetCallback(show_panel_callback);self.ui.pos_y:SetCallback(show_panel_callback)end;function CourierPanelModule:Show(duration)self.is_visible=true;self.show_until_time=GlobalVars.GetCurTime()+duration end;function CourierPanelModule:Hide()if self.is_visible then self.is_visible=false;self.show_until_time=0 end end;function CourierPanelModule:Action_StartDelivery(target)DeliveryManager:StartDelivery(target);self:Hide()end;function CourierPanelModule:OnDraw()local local_hero_on_draw=Heroes.GetLocal();if not local_hero_on_draw then if self.is_visible then self:Hide()end;return end;local is_lone_druid=(NPC.GetUnitName(local_hero_on_draw)=="npc_dota_hero_lone_druid");if not agent_script.ui.enable_courier_utility:Get()or not is_lone_druid then if self.is_visible then self:Hide()end;return end;local dt=GlobalVars.GetAbsFrameTime();if self.is_visible and GlobalVars.GetCurTime()>self.show_until_time then self:Hide()end;local target_alpha=self.is_visible and 1.0 or 0.0;if self.current_alpha<0.01 and target_alpha<0.01 then return end;self.current_alpha=self.current_alpha+(target_alpha-self.current_alpha)*self.animation_speed*dt;if self.current_alpha<0.01 then return end;local panel_pos=Vec2(self.ui.pos_x:Get(),self.ui.pos_y:Get());local panel_end_pos=panel_pos+self.panel_size;local rounding=8.0;local color_shadow=Color(0,0,0,150*self.current_alpha);local color_bg=Color(25,30,45,230*self.current_alpha);local color_outline_bright=Color(100,180,255,200*self.current_alpha);local color_outline_dark=Color(30,50,80,200*self.current_alpha);local color_text=Color(220,220,220,255*self.current_alpha);local color_title=Color(255,255,255,255*self.current_alpha);Render.Shadow(panel_pos,panel_end_pos,color_shadow,12.0,rounding);Render.Blur(panel_pos,panel_end_pos,2.0,self.current_alpha*0.9,rounding);Render.FilledRect(panel_pos,panel_end_pos,color_bg,rounding);Render.OutlineGradient(panel_pos,panel_end_pos,color_outline_bright,color_outline_bright,color_outline_dark,color_outline_dark,rounding,Enum.DrawFlags.None,1.5);local title_text="Кому передать?";local title_size=Render.TextSize(self.font,16,title_text);Render.Text(self.font,16,title_text,panel_pos+Vec2((self.panel_size.x-title_size.x)/2,8),color_title);local button_size=Vec2(80,30);local btn_hero_pos=panel_pos+Vec2(10,40);local btn_bear_pos=panel_pos+Vec2(self.panel_size.x-button_size.x-10,40);local is_hover_hero=Input.IsCursorInRect(btn_hero_pos.x,btn_hero_pos.y,button_size.x,button_size.y);Render.FilledRect(btn_hero_pos,btn_hero_pos+button_size,is_hover_hero and Color(80,130,200,50*self.current_alpha)or Color(0,0,0,0),4.0);Render.OutlineGradient(btn_hero_pos,btn_hero_pos+button_size,color_outline_bright,color_outline_bright,color_outline_dark,color_outline_dark,4.0,Enum.DrawFlags.None,1.0);local text_hero_size=Render.TextSize(self.font,14,"Герою");Render.Text(self.font,14,"Герою",btn_hero_pos+Vec2((button_size.x-text_hero_size.x)/2,7),color_text);if self.is_visible and is_hover_hero and Input.IsKeyDownOnce(Enum.ButtonCode.KEY_MOUSE1)then if Entity.IsAlive(local_hero_on_draw)then self:Action_StartDelivery(local_hero_on_draw)else self:Hide()end end;local is_hover_bear=Input.IsCursorInRect(btn_bear_pos.x,btn_bear_pos.y,button_size.x,button_size.y);Render.FilledRect(btn_bear_pos,btn_bear_pos+button_size,is_hover_bear and Color(80,130,200,50*self.current_alpha)or Color(0,0,0,0),4.0);Render.OutlineGradient(btn_bear_pos,btn_bear_pos+button_size,color_outline_bright,color_outline_bright,color_outline_dark,color_outline_dark,4.0,Enum.DrawFlags.None,1.0);local text_bear_size=Render.TextSize(self.font,14,"Медведю");Render.Text(self.font,14,"Медведю",btn_bear_pos+Vec2((button_size.x-text_bear_size.x)/2,7),color_text);if self.is_visible and is_hover_bear and Input.IsKeyDownOnce(Enum.ButtonCode.KEY_MOUSE1)then local bear=NPC.GetAbility(local_hero_on_draw,"lone_druid_spirit_bear")and CustomEntities.GetSpiritBear(NPC.GetAbility(local_hero_on_draw,"lone_druid_spirit_bear"))or nil;if bear and Entity.IsAlive(bear)then self:Action_StartDelivery(bear)else self:Hide()end end end;function CourierPanelModule:OnGameEnd()self:Hide()end;local OrderInterceptorModule={};function OrderInterceptorModule:CheckForCourierTransferOrder(data)if not my_hero or NPC.GetUnitName(my_hero)~="npc_dota_hero_lone_druid"then return true end;if not agent_script.ui.enable_courier_utility:Get()or not data.ability then return true end;local ability_name=Ability.GetName(data.ability);if ability_name~="courier_take_stash_and_transfer_items"and ability_name~="courier_transfer_items"then return true end;local actor_unit=nil;if data.orderIssuer==Enum.PlayerOrderIssuer.DOTA_ORDER_ISSUER_PASSED_UNIT_ONLY then actor_unit=data.npc else local selected=Player.GetSelectedUnits(data.player or Players.GetLocal());if selected and #selected>0 then actor_unit=selected[1]end end;if actor_unit and NPC.IsCourier(actor_unit)then CourierPanelModule:Show(5);return false end;return true end;local AssistModule={};function AssistModule.OnPlayerOrder(data)if not agent_script.ui.enable:Get()or not my_hero then return end;for _,agent in pairs(agent_manager)do if agent.state==STATES.FIGHTING or agent.state==STATES.INTERRUPTING then return end end;local farm_target=nil;if data.order==Enum.UnitOrder.DOTA_UNIT_ORDER_ATTACK_TARGET and data.target and NPC.IsCreep(data.target)and not NPC.IsLaneCreep(data.target)then farm_target=data.target elseif data.order==Enum.UnitOrder.DOTA_UNIT_ORDER_ATTACK_MOVE then local hero_pos=Entity.GetAbsOrigin(my_hero);local potential_creeps=NPCs.InRadius(hero_pos,1200,Entity.GetTeamNum(my_hero),Enum.TeamType.TEAM_ENEMY);local closest_creep=nil;local min_dist=99999;for _,creep in ipairs(potential_creeps)do if NPC.IsCreep(creep)and not NPC.IsLaneCreep(creep)and Entity.IsAlive(creep)then local dist=hero_pos:Distance(Entity.GetAbsOrigin(creep));if dist<min_dist then min_dist=dist;closest_creep=creep end end end;farm_target=closest_creep end;if farm_target then for _,agent in pairs(agent_manager)do if agent and agent.unit and Entity.IsAlive(agent.unit)then agent.state=STATES.FARMING;agent.target=farm_target;agent.thought="Помогаю фармить";agent.manual_override_until=0 end end end end;do local main_tab=Menu.Create("Scripts","Other","AI Медведь");if main_tab then main_tab:Icon("\u{f52d}");local main_group=main_tab:Create("Main");local settings_group=main_group:Create("Main Settings");agent_script.ui.enable=settings_group:Switch("Включить AI для Медведя",true,"panorama/images/heroes/icons/npc_dota_hero_lone_druid_png.vtex_c");agent_script.ui.enable:ToolTip("Полностью включает или выключает логику скрипта для медведя.");agent_script.ui.debug_draw=settings_group:Switch("Отображать отладку",true,"\u{f05a}");agent_script.ui.debug_draw:ToolTip("Показывает состояние, цель и мысли медведя в игре.");agent_script.ui.enable_by_timer=settings_group:Switch("Включить по таймеру",false,"\u{f017}");agent_script.ui.enable_by_timer:ToolTip("Если включено, AI медведя (кроме помощника доставки) активируется только после указанной минуты.");agent_script.ui.activation_minute=settings_group:Slider("Минута включения",1,15,5,"%d мин");agent_script.ui.activation_minute:ToolTip("Устанавливает минуту игрового времени, после которой AI начнет работать.");agent_script.ui.follow_distance=settings_group:Slider("Дистанция следования",200,500,300,"%d");agent_script.ui.follow_distance:ToolTip("На каком расстоянии медведь будет следовать за героем в состоянии ожидания");agent_script.ui.auto_skill_on_entangle=settings_group:Switch("Авто-прокачка с корней",true,"panorama/images/spellicons/lone_druid_spirit_bear_entangle_png.vtex_c");agent_script.ui.auto_skill_on_entangle:ToolTip("Автоматически прокачивать способность Spirit Bear если можно прокачать и враг в корнях");local attack_items_group=main_group:Create("Attack Items");agent_script.ui.item_multiselect=attack_items_group:MultiSelect("Медведь использует:",{{"item_diffusa","panorama/images/items/diffusal_blade_png.vtex_c",true},{"item_disperser","panorama/images/items/disperser_png.vtex_c",true},{"item_orchid","panorama/images/items/orchid_png.vtex_c",true},{"item_bloodthorn","panorama/images/items/bloodthorn_png.vtex_c",true},{"item_harpoon","panorama/images/items/harpoon_png.vtex_c",true},{"item_abyssal_blade","panorama/images/items/abyssal_blade_png.vtex_c",true},{"item_mask_of_madness","panorama/images/items/mask_of_madness_png.vtex_c",true}},true);agent_script.ui.item_multiselect:ToolTip("Выберите предметы, которые медведь будет использовать в бою.");local save_group=main_group:Create("Save Abilities");agent_script.ui.enable_roar=save_group:Switch("Использовать Savage Roar (защита)",true,"panorama/images/spellicons/lone_druid_savage_roar_png.vtex_c");agent_script.ui.enable_roar:ToolTip("Позволяет медведю использовать Savage Roar для спасения друида, если куплен шард.");agent_script.ui.enable_disperser_save=save_group:Switch("Использовать Disperser (защита)",true,"panorama/images/items/disperser_png.vtex_c");agent_script.ui.enable_disperser_save:ToolTip("Позволяет медведю использовать Disperser на друида, чтобы снять с него негативные эффекты.");local interrupt_group=main_group:Create("Interrupts");agent_script.ui.auto_interrupt_casts=interrupt_group:Switch("Сбивать касты",true,"\u{f73c}");agent_script.ui.auto_interrupt_casts:ToolTip("Включает автоматическое прерывания способностей противника (ульт энигмы, ульт цмки).");agent_script.ui.interrupt_tools_multiselect=interrupt_group:MultiSelect("Чем сбивать:",{{"orchid_bloodthorn","panorama/images/items/orchid_png.vtex_c",true},{"savage_roar","panorama/images/spellicons/lone_druid_savage_roar_png.vtex_c",true}},true);agent_script.ui.interrupt_tools_multiselect:ToolTip("Выберите, какие способности и предметы будут использоваться для прерывания кастов.");local courier_group=main_group:Create("Courier Utility");agent_script.ui.enable_courier_utility=courier_group:Switch("Включить помощника доставки",true,"\u{f0d1}");agent_script.ui.enable_courier_utility:ToolTip("Перехватывает ордера доставки курьера и предлагает выбор цели (герой или медведь).");CourierPanelModule:Init(courier_group);agent_script.ui.enable_courier_utility:SetCallback(function()local enabled=agent_script.ui.enable_courier_utility:Get();CourierPanelModule.ui.pos_x:Disabled(not enabled);CourierPanelModule.ui.pos_y:Disabled(not enabled)end,true)end end;local threat_list={};local Agent={};Agent.__index=Agent;function Agent.new(unit)return setmetatable({unit=unit,handle=Entity.GetIndex(unit),state=STATES.FOLLOWING,target=nil,target_score=0,thought="Инициализация...",next_action_time=0,manual_override_until=0},Agent)end;function Agent:UseAbilityOrItem(name,target,is_item)local ability=is_item and NPC.GetItem(self.unit,name)or NPC.GetAbility(self.unit,name);if not(ability and Ability.IsReady(ability))then return false end;if target then Ability.CastTarget(ability,target)else Ability.CastNoTarget(ability)end;return true end;function Agent:Attack(target)Player.PrepareUnitOrders(local_player,Enum.UnitOrder.DOTA_UNIT_ORDER_ATTACK_TARGET,target,nil,nil,Enum.PlayerOrderIssuer.DOTA_ORDER_ISSUER_PASSED_UNIT_ONLY,self.unit)end;function Agent:MoveTo(position)Player.PrepareUnitOrders(local_player,Enum.UnitOrder.DOTA_UNIT_ORDER_MOVE_TO_POSITION,nil,position,nil,Enum.PlayerOrderIssuer.DOTA_ORDER_ISSUER_PASSED_UNIT_ONLY,self.unit)end;function Agent:HoldPosition()Player.PrepareUnitOrders(local_player,Enum.UnitOrder.DOTA_UNIT_ORDER_HOLD_POSITION,nil,Entity.GetAbsOrigin(self.unit),nil,Enum.PlayerOrderIssuer.DOTA_ORDER_ISSUER_PASSED_UNIT_ONLY,self.unit)end;local Actions={};function Actions.ExecuteSAVING_LOGIC(agent)if not my_hero or not(NPC.IsSilenced(my_hero)or NPC.HasState(my_hero,Enum.ModifierState.MODIFIER_STATE_ROOTED))then return false end;if agent_script.ui.enable_disperser_save:Get()and agent:UseAbilityOrItem("item_disperser",my_hero,true)then agent.thought="Снимаю дебаффы с друида";return true end;if agent_script.ui.enable_roar:Get()and NPC.HasShard(my_hero)and agent:UseAbilityOrItem("lone_druid_savage_roar_bear",nil,false)then agent.thought="Спасаю друида";return true end;return false end;function Actions.ExecuteFOLLOWING(agent)if my_hero and Entity.IsAlive(my_hero)then local follow_dist=agent_script.ui.follow_distance:Get();if Entity.GetAbsOrigin(agent.unit):Distance(Entity.GetAbsOrigin(my_hero))>follow_dist then agent:MoveTo(Entity.GetAbsOrigin(my_hero));agent.thought="Следую."else agent:HoldPosition();agent.thought="Ожидаю."end;return true end;return false end;function Actions.ExecuteINTERRUPTING(agent)local target=agent.target;if not target or not Entity.IsAlive(target)then agent.state=STATES.FOLLOWING;return false end;local enemy_activity=NPC.GetActivity(target);local casting_ability=NPC.GetChannellingAbility(target)or NPC.GetAbilityByActivity(target,enemy_activity);local is_casting_or_channeling=(enemy_activity>=Enum.GameActivity.ACT_DOTA_CAST_ABILITY_1 and enemy_activity<=Enum.GameActivity.ACT_DOTA_CAST_ABILITY_7)or NPC.IsChannellingAbility(target);if not is_casting_or_channeling then agent.state=STATES.FOLLOWING;return false end;agent.thought="Прерываю "..(casting_ability and Ability.GetName(casting_ability)or"каст").."!";local used_interrupt=false;if not used_interrupt and agent_script.ui.interrupt_tools_multiselect:Get("orchid_bloodthorn")then if agent:UseAbilityOrItem("item_bloodthorn",target,true)then used_interrupt=true elseif agent:UseAbilityOrItem("item_orchid",target,true)then used_interrupt=true end end;if not used_interrupt and agent_script.ui.interrupt_tools_multiselect:Get("savage_roar")and NPC.HasShard(my_hero)then local bear_roar=NPC.GetAbility(agent.unit,"lone_druid_savage_roar_bear");local hero_roar=NPC.GetAbility(my_hero,"lone_druid_savage_roar");if(bear_roar and Ability.IsReady(bear_roar))or(hero_roar and Ability.IsReady(hero_roar))then local distance=Entity.GetAbsOrigin(agent.unit):Distance(Entity.GetAbsOrigin(target));if distance>325 then agent:MoveTo(Entity.GetAbsOrigin(target));agent.thought="Сближаюсь для рора";return true else if agent:UseAbilityOrItem("lone_druid_savage_roar_bear",nil,false)then used_interrupt=true elseif hero_roar and Ability.IsReady(hero_roar)then Ability.CastNoTarget(hero_roar);used_interrupt=true end end end end;if used_interrupt then agent.state=STATES.FOLLOWING;return true end;return false end;function Actions.ExecuteFIGHTING(agent)local target=agent.target;if not target or not Entity.IsAlive(target)or Entity.GetAbsOrigin(my_hero):Distance(Entity.GetAbsOrigin(target))>1100 then agent.state=STATES.FOLLOWING;agent.target=nil;return false end;if agent_script.ui.auto_skill_on_entangle:Get()and NPC.HasModifier(target,"modifier_lone_druid_spirit_bear_entangle_effect")then if Hero.GetAbilityPoints(my_hero)>0 then local bear_ability=NPC.GetAbility(my_hero,"lone_druid_spirit_bear");if bear_ability and Ability.GetLevel(bear_ability)<Ability.GetMaxLevel(bear_ability)then Player.PrepareUnitOrders(Players.GetLocal(),Enum.UnitOrder.DOTA_UNIT_ORDER_TRAIN_ABILITY,nil,nil,bear_ability,Enum.PlayerOrderIssuer.DOTA_ORDER_ISSUER_HERO_ONLY,my_hero);return true end end end;local distance=Entity.GetAbsOrigin(agent.unit):Distance(Entity.GetAbsOrigin(target));local attack_range=NPC.GetAttackRange(agent.unit)+NPC.GetAttackRangeBonus(agent.unit)+NPC.GetHullRadius(agent.unit)+NPC.GetHullRadius(target);if distance>attack_range then if agent_script.ui.item_multiselect:Get("item_harpoon")and agent:UseAbilityOrItem("item_harpoon",target,true)then agent.thought="Сближаюсь (Harpoon)";return true end;agent:MoveTo(Entity.GetAbsOrigin(target));agent.thought="Двигаюсь к цели";return true end;local is_stunned=NPC.IsStunned(target);local is_rooted=NPC.HasState(target,Enum.ModifierState.MODIFIER_STATE_ROOTED);local is_silenced=NPC.IsSilenced(target);if not is_silenced then if agent_script.ui.item_multiselect:Get("item_bloodthorn")and agent:UseAbilityOrItem("item_bloodthorn",target,true)then agent.thought="Сайленс (Bloodthorn)";return true end;if agent_script.ui.item_multiselect:Get("item_orchid")and agent:UseAbilityOrItem("item_orchid",target,true)then agent.thought="Сайленс (Orchid)";return true end end;if agent_script.ui.item_multiselect:Get("item_diffusa")and agent:UseAbilityOrItem("item_diffusal_blade",target,true)then agent.thought="Замедляю (diffuza)";return true end;if agent_script.ui.item_multiselect:Get("item_disperser")and agent:UseAbilityOrItem("item_disperser",target,true)then agent.thought="Замедляю (Disperser)";return true end;if not is_stunned and not is_rooted and agent_script.ui.item_multiselect:Get("item_abyssal_blade")and agent:UseAbilityOrItem("item_abyssal_blade",target,true)then agent.thought="Оглушаю (абоссал)";return true end;if(is_stunned or is_rooted)and agent_script.ui.item_multiselect:Get("item_mask_of_madness")and not NPC.HasModifier(agent.unit,"modifier_mask_of_madness_berserk")and agent:UseAbilityOrItem("item_mask_of_madness",nil,true)then agent.thought="Включаю MoM";return true end;agent:Attack(target);agent.thought="Атакую цель";return true end;function Actions.ExecuteFARMING(agent)local target=agent.target;if not target or not Entity.IsAlive(target)then agent.state=STATES.FOLLOWING;agent.thought="Закончил фармить.";agent.target=nil;agent.target_score=0;return false end;local distance=Entity.GetAbsOrigin(agent.unit):Distance(Entity.GetAbsOrigin(target));local attack_range=NPC.GetAttackRange(agent.unit)+NPC.GetAttackRangeBonus(agent.unit)+NPC.GetHullRadius(agent.unit)+NPC.GetHullRadius(target);if distance>attack_range then agent:MoveTo(Entity.GetAbsOrigin(target));agent.thought="Иду фармить крипа";return true end;agent:Attack(target);agent.thought="Фармлю крипа";return true end;local ACTION_DISPATCHER={[STATES.FOLLOWING]=Actions.ExecuteFOLLOWING,[STATES.FIGHTING]=Actions.ExecuteFIGHTING,[STATES.FARMING]=Actions.ExecuteFARMING};function CalculateTargetScore(agent,target)local score=0;local h=Entity.GetIndex(target);if threat_list[h]and GlobalVars.GetCurTime()<threat_list[h]then score=score+200 end;if NPC.HasState(target,Enum.ModifierState.MODIFIER_STATE_STUNNED)or NPC.HasState(target,Enum.ModifierState.MODIFIER_STATE_ROOTED)then score=score+200 end;local m=Entity.GetMaxHealth(target)-Entity.GetHealth(target);score=score+(m/100)*10;if NPC.HasAegis(target)then score=score-1000 end;local d=Entity.GetAbsOrigin(agent.unit):Distance(Entity.GetAbsOrigin(target));score=score-(d/100)*5;return score end;function FindBestHeroTarget(agent)local potential_targets={};for _,hero in pairs(Heroes.GetAll())do if not Entity.IsSameTeam(hero,my_hero)and Entity.IsAlive(hero)and NPC.IsVisible(hero)and not NPC.IsIllusion(hero)and Entity.GetAbsOrigin(my_hero):Distance(Entity.GetAbsOrigin(hero))<=1100 then table.insert(potential_targets,hero)end end;if #potential_targets>0 then local best_target,best_score=nil,-999999;for _,candidate in ipairs(potential_targets)do local current_score=CalculateTargetScore(agent,candidate);if current_score>best_score then best_score,best_target=current_score,candidate end end;return best_target,best_score end;return nil,0 end;function agent_script.OnUpdate()DeliveryManager:OnUpdate();if not agent_script.ui.enable:Get()or not Engine.IsInGame()then return end;if agent_script.ui.enable_by_timer:Get()then local game_time_seconds=GameRules.GetDOTATime(false,true);local activation_time_seconds=agent_script.ui.activation_minute:Get()*60;if game_time_seconds<activation_time_seconds then return end end;my_hero=Heroes.GetLocal();local_player=Players.GetLocal();if not my_hero or not Entity.IsAlive(my_hero)or not local_player or NPC.GetUnitName(my_hero)~="npc_dota_hero_lone_druid"then agent_manager={};return end;local bear_ability=NPC.GetAbility(my_hero,"lone_druid_spirit_bear");local bear=bear_ability and Ability.GetLevel(bear_ability)>0 and CustomEntities.GetSpiritBear(bear_ability)or nil;if bear and Entity.IsAlive(bear)then if not agent_manager[Entity.GetIndex(bear)]then agent_manager[Entity.GetIndex(bear)]=Agent.new(bear)end else agent_manager={};return end;local interrupt_target,casting_ability=nil,nil;if agent_script.ui.auto_interrupt_casts:Get()then for _,enemy in pairs(Heroes.GetAll())do if not Entity.IsSameTeam(enemy,my_hero)and Entity.IsAlive(enemy)and NPC.IsVisible(enemy)and Entity.GetAbsOrigin(my_hero):Distance(Entity.GetAbsOrigin(enemy))<=1200 then if NPC.IsChannellingAbility(enemy)then interrupt_target=enemy;casting_ability=NPC.GetChannellingAbility(enemy)or NPC.GetAbilityByActivity(enemy,enemy_activity);break end end end end;for handle,agent in pairs(agent_manager)do local current_time=GlobalVars.GetCurTime();if current_time<agent.next_action_time then goto continue_loop end;if current_time<agent.manual_override_until then agent.state=STATES.MANUAL_OVERRIDE;agent.thought=string.format("Ручное управление (%.1fs)",math.max(0,agent.manual_override_until-current_time));goto continue_loop elseif agent.state==STATES.MANUAL_OVERRIDE then agent.state=STATES.FOLLOWING;agent.thought="Переход в AI режим."end;if interrupt_target then if agent.state~=STATES.INTERRUPTING then agent.state=STATES.INTERRUPTING;agent.target=interrupt_target end;if not Actions.ExecuteINTERRUPTING(agent)then agent.state=STATES.FIGHTING else agent.next_action_time=current_time+0.5;goto continue_loop end elseif agent.state==STATES.INTERRUPTING then agent.state=STATES.FOLLOWING end;if Actions.ExecuteSAVING_LOGIC(agent)then agent.next_action_time=current_time+0.5;goto continue_loop end;if agent.state~=STATES.INTERRUPTING then local best_enemy_target,enemy_score=FindBestHeroTarget(agent);if best_enemy_target then if agent.state~=STATES.FIGHTING then end;agent.state=STATES.FIGHTING;agent.target=best_enemy_target;agent.target_score=enemy_score elseif agent.state==STATES.FIGHTING then agent.state=STATES.FOLLOWING;agent.target=nil end end;if ACTION_DISPATCHER[agent.state]and ACTION_DISPATCHER[agent.state](agent)then agent.next_action_time=current_time+0.5 end;::continue_loop::end end;function agent_script.OnDraw()CourierPanelModule:OnDraw();if not agent_script.ui.enable:Get()or not agent_script.ui.debug_draw:Get()then return end;if not font then font=Render.LoadFont("Arial",12,Enum.FontCreate.FONTFLAG_OUTLINE)end;for _,a in pairs(agent_manager)do if a.unit and Entity.IsAlive(a.unit)then local p=Entity.GetAbsOrigin(a.unit)+Vector(0,0,NPC.GetHealthBarOffset(a.unit)+20);local s,v=Render.WorldToScreen(p);if v then local display_color=Color(180,220,255,255);if a.state==STATES.MANUAL_OVERRIDE then display_color=Color(255,165,0,255)elseif a.state==STATES.FIGHTING then display_color=Color(255,50,50,255)elseif a.state==STATES.FARMING then display_color=Color(100,255,100,255)elseif a.state==STATES.INTERRUPTING then display_color=Color(255,100,255,255)end;Render.Text(font,12,string.format("Состояние: [%s]",a.state),Vec2(s.x,s.y),display_color);Render.Text(font,12,string.format("Мысль: %s",a.thought),Vec2(s.x,s.y+12),Color(255,255,255,255));if a.target and Entity.IsAlive(a.target)and a.target~=my_hero and a.state~=STATES.MANUAL_OVERRIDE then local ts,_=Render.WorldToScreen(Entity.GetAbsOrigin(a.target));if ts then Render.Line(s,ts,Color(255,0,0,150));if a.state==STATES.FIGHTING or a.state==STATES.FARMING then Render.Text(font,12,string.format("Оценка: %.0f",a.target_score),Vec2(s.x,s.y+24),Color(255,255,100,255))end end end end end end end;function agent_script.OnPrepareUnitOrders(data)local player=data.player or Players.GetLocal();if not player then return true end;if DeliveryManager.isActive then local courier=Couriers.GetLocal();if courier then local isCourierOrder=false;if data.npc and data.npc==courier then isCourierOrder=true else local selected_units=Player.GetSelectedUnits(player);for _,unit in ipairs(selected_units)do if unit==courier then isCourierOrder=true;break end end end;if isCourierOrder and data.order~=Enum.UnitOrder.DOTA_UNIT_ORDER_GIVE_ITEM then DeliveryManager:StopDelivery()end end end;if not OrderInterceptorModule:CheckForCourierTransferOrder(data)then return false end;if not agent_script.ui.enable:Get()then return true end;if data.orderIssuer==Enum.PlayerOrderIssuer.DOTA_ORDER_ISSUER_PASSED_UNIT_ONLY then return true end;local is_manual_override=false;local selected_units=Player.GetSelectedUnits(player);if selected_units then for _,unit in ipairs(selected_units)do if unit and agent_manager[Entity.GetIndex(unit)]then agent_manager[Entity.GetIndex(unit)].manual_override_until=GlobalVars.GetCurTime()+5;is_manual_override=true end end end;if is_manual_override then return true end;AssistModule.OnPlayerOrder(data);return true end;function agent_script.OnEntityHurt(data)if not agent_script.ui.enable:Get()or not my_hero or not data or not data.target or not data.source then return end;if data.target~=my_hero then return end;if Entity.IsHero(data.source)and not Entity.IsSameTeam(data.source,my_hero)and not NPC.IsIllusion(data.source)then local h=Entity.GetIndex(data.source);threat_list[h]=GlobalVars.GetCurTime()+3;return end;if NPC.IsCreep(data.source)and not NPC.IsLaneCreep(data.source)then for _,agent in pairs(agent_manager)do if agent.state==STATES.FOLLOWING then agent.state=STATES.FARMING;agent.target=data.source;agent.thought="Защищаю от крипа";agent.manual_override_until=0;return end end end end;function agent_script.OnGameEnd()my_hero,local_player,agent_manager,threat_list=nil,nil,{},{};CourierPanelModule:OnGameEnd();DeliveryManager:OnGameEnd()end;return agent_script
